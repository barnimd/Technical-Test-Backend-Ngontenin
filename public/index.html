<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Management</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        main { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #1a202c; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #e2e8f0; }
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; color: rgb(255, 255, 255); margin-right: 5px; }
        .btn-edit { background-color: #3490dc; }
        .btn-delete { background-color: #e3342f; }
        .btn-search { background-color: #102dd1; }
        .btn-create { display: block; width: fit-content; margin: 20px 0; padding: 10px 15px; background-color: #38c172; color: white; text-decoration: none; border-radius: 5px; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { background-color: #22ee44; }
        .pagination button:disabled { background-color: #292a2b; cursor: not-allowed; }
        .search-container { margin: 20px 0; display: flex; gap: 10px; }
        input[type="text"], input[type="date"], textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        dialog { border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 20px; width: 400px; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <main>
        <h1>Manajemen Buku</h1>
        <button class="btn-create" id="showCreateModalBtn">Tambah Buku Baru</button>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Cari berdasarkan judul atau deskripsi...">
            <button class= "btn-search" id="searchBtn">Cari</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nama Buku</th>
                    <th>Penulis</th>
                    <th>Deskripsi</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="book-list">
                </tbody>
        </table>

        <div class="pagination" id="pagination-controls">
            </div>
    </main>

    <dialog id="bookModal">
        <h2 id="modalTitle">Tambah Buku Baru</h2>
        <form id="bookForm">
            <input type="hidden" id="bookId">
            <div>
                <label for="book_name">Nama Buku</label>
                <input type="text" id="book_name" required maxlength="150">
            </div>
            <div>
                <label for="author">Penulis</label>
                <input type="text" id="author" required maxlength="150">
            </div>
            <div>
                <label for="published_date">Tanggal Terbit</label>
                <input type="date" id="published_date" required>
            </div>
            <div>
                <label for="description">Deskripsi</label>
                <textarea id="description" rows="4"></textarea>
            </div>
            <button type="submit">Simpan</button>
            <button type="button" id="closeModalBtn">Batal</button>
        </form>
    </dialog>


    <script>
        // URL dasar dari API backend
        const API_URL = 'http://127.0.0.1:8000/api';

        // Elemen-elemen DOM yang akan di gunakan
        const bookList = document.getElementById('book-list');
        const paginationControls = document.getElementById('pagination-controls');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const bookModal = document.getElementById('bookModal');
        const bookForm = document.getElementById('bookForm');
        const showCreateModalBtn = document.getElementById('showCreateModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTitle = document.getElementById('modalTitle');

        /**
         * Fungsi utama untuk mengambil dan menampilkan data buku
         * Mendukung paginasi dan pencarian
         */
        async function fetchBooks(page = 1, searchTerm = '') {
            let url = '';
            if (searchTerm) {
                url = `${API_URL}/books/search?query=${searchTerm}&page=${page}`;
            } else {
                url = `${API_URL}/books?page=${page}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                renderBooks(data.data);
                renderPagination(data);
            } catch (error) {
                console.error('Error fetching books:', error);
                bookList.innerHTML = '<tr><td colspan="5">Gagal memuat data. Coba lagi nanti.</td></tr>';
            }
        }

        /**
         * Merender daftar buku ke dalam tabel HTML
         */
        function renderBooks(books) {
            bookList.innerHTML = ''; // Kosongkan tabel sebelum diisi
            if (books.length === 0) {
                bookList.innerHTML = '<tr><td colspan="5">Tidak ada buku ditemukan.</td></tr>';
                return;
            }
            books.forEach(book => {
                const row = `
                    <tr>
                        <td>${book.id}</td>
                        <td>${book.book_name}</td>
                        <td>${book.author}</td>
                        <td>${book.description || ''}</td>
                        <td>
                            <button class="btn-edit" data-id="${book.id}" data-description="${book.description}">Edit</button>
                            <button class="btn-delete" data-id="${book.id}">Hapus</button>
                        </td>
                    </tr>
                `;
                bookList.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * Merender kontrol paginasi (tombol-tombol halaman)
         */
        function renderPagination(paginationData) {
            paginationControls.innerHTML = '';
            // Tombol Previous
            const prevButton = document.createElement('button');
            prevButton.innerText = 'Sebelumnya';
            prevButton.disabled = !paginationData.prev_page_url;
            prevButton.onclick = () => fetchBooks(paginationData.current_page - 1);
            paginationControls.appendChild(prevButton);

            // Teks Halaman Saat Ini
            const pageInfo = document.createElement('span');
            pageInfo.innerText = ` Halaman ${paginationData.current_page} dari ${paginationData.last_page} `;
            pageInfo.style.margin = '0 10px';
            paginationControls.appendChild(pageInfo);

            // Tombol Next
            const nextButton = document.createElement('button');
            nextButton.innerText = 'Berikutnya';
            nextButton.disabled = !paginationData.next_page_url;
            nextButton.onclick = () => fetchBooks(paginationData.current_page + 1);
            paginationControls.appendChild(nextButton);
        }

        /**
         * Menangani submit form untuk membuat atau mengedit buku
         */
        bookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const isEditing = !!id;

            // Kumpulkan data dari form
            const formData = {
                description: document.getElementById('description').value,
            };

            let url = `${API_URL}/books`;
            let method = 'POST';

            if (isEditing) {
                url = `${API_URL}/books/${id}`;
                method = 'PUT';
            } else {
                // Hanya tambahkan field ini saat membuat buku baru
                formData.book_name = document.getElementById('book_name').value;
                formData.author = document.getElementById('author').value;
                formData.published_date = document.getElementById('published_date').value;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData.errors));
                }

                bookModal.close();
                fetchBooks(); // Muat ulang daftar buku
            } catch (error) {
                console.error('Error saving book:', error);
                alert('Gagal menyimpan buku: ' + error.message);
            }
        });

        /**
         * Event listener untuk tombol di dalam tabel (Edit dan Hapus)
         * Menggunakan event delegation
         */
        bookList.addEventListener('click', async (e) => {
            const target = e.target;

            // Tombol Edit
            if (target.classList.contains('btn-edit')) {
                const id = target.dataset.id;
                const description = target.dataset.description;

                // Isi form edit
                modalTitle.innerText = 'Edit Deskripsi Buku';
                document.getElementById('bookId').value = id;
                document.getElementById('description').value = description;

                // Sembunyikan dan nonaktifkan field yang tidak bisa diedit
                document.getElementById('book_name').parentElement.style.display = 'none';
                document.getElementById('author').parentElement.style.display = 'none';
                document.getElementById('published_date').parentElement.style.display = 'none';

                bookModal.showModal();
            }

            // Tombol Hapus
            if (target.classList.contains('btn-delete')) {
                const id = target.dataset.id;
                if (confirm(`Apakah kamu yakin ingin menghapus buku dengan ID ${id}?`)) {
                    try {
                        const response = await fetch(`${API_URL}/books/${id}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) {
                            throw new Error('Gagal menghapus buku.');
                        }
                        fetchBooks(); // Muat ulang daftar buku
                    } catch (error) {
                        console.error('Error deleting book:', error);
                        alert(error.message);
                    }
                }
            }
        });

        // Event listener untuk tombol pencarian
        searchBtn.addEventListener('click', () => {
            fetchBooks(1, searchInput.value.trim());
        });

        // Event listener untuk membersihkan pencarian saat input kosong
        searchInput.addEventListener('keyup', (e) => {
            if (e.target.value === '') {
                fetchBooks();
            }
        });

        // Event listener untuk menampilkan modul tambah buku
        showCreateModalBtn.addEventListener('click', () => {
            bookForm.reset();
            modalTitle.innerText = 'Tambah Buku Baru';
            document.getElementById('bookId').value = '';

            // Tampilkan kembali field yang disembunyikan
            document.getElementById('book_name').parentElement.style.display = 'block';
            document.getElementById('author').parentElement.style.display = 'block';
            document.getElementById('published_date').parentElement.style.display = 'block';

            bookModal.showModal();
        });

        // Event listener untuk tombol tutup modul
        closeModalBtn.addEventListener('click', () => {
            bookModal.close();
        });

        // Muat data buku pertama kali saat halaman dibuka
        document.addEventListener('DOMContentLoaded', () => {
            fetchBooks();
        });
    </script>

</body>
</html>
